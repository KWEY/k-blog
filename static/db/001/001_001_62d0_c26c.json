{
	"title": "解析ArraryBuffer",
	"id": "001_001_62d0_c26c",
	"time": "2019/1/5 下午5:10:41",
	"context": "<p>1. 文件格式 (mask file layout)<br><br>1.0 综述 (overview)<br>-----------------------------------<br>| mask file header |<br>-----------------------------------<br>| mask frame indexing table |<br>-----------------------------------<br>| ... ... |<br>| ... ... |<br>-----------------------------------<br>| mask frames data segment |<br>-----------------------------------<br>图 1.0<br><br>总体而言, 文件的格式为: 文件头 + 帧索引表 + 若干帧数据段, 这三部分数据紧邻地存放于mask文件<br>中, 位置关系如图1.0所示.<br><br>1.1 文件头 (mask file header)<br><br>| 1 bytes |&nbsp; 1 bytes&nbsp; |&nbsp; &nbsp;1 byte&nbsp; &nbsp; |&nbsp; &nbsp;1 bytes&nbsp; &nbsp; |&nbsp; &nbsp; 1 bytes&nbsp; &nbsp;|<br>--------------------------------------------------------<br>| file tag&nbsp; |&nbsp; version&nbsp; | codec_id&nbsp; |&nbsp; reserved&nbsp; | entry_num |<br>--------------------------------------------------------<br>图 1.1<br>说明:<br>文件头固定为16字节, 位于mask文件的前16字节. 文件头的组成由图2.1所示<br>file tag: 表示文件标识, 固定值为 \"AAAA\", 占用4字节, 可以视作 magic number<br>version: 表示文件版本号, 占用4字节, 网络序, 无符号整型, 目前合法值为 1, 遇到高版本需视为无效文件<br>codec_id: 表示编码方式, 占用1字节, 无符号整型, 描述了帧和帧数据段的编码格式, 目前合法值为:<br><br>| codec_id | 帧编码方式 | 帧数据段格式 |<br>--------------------------------------------------------------------------------------------------<br>| 0x0 | bitstream | 一系列帧按照pts_time_ms从小到大紧密排列, 而后使用gzip压缩 |<br>--------------------------------------------------------------------------------------------------<br>| 0x1 | svg | 一系列帧按照pts_time_ms从小到大紧密排列, 不压缩 |<br>--------------------------------------------------------------------------------------------------<br>| 0x2 | svg | 一系列帧按照pts_time_ms从小到大紧密排列, 后使用gzip压缩 |&nbsp;<br>--------------------------------------------------------------------------------------------------<br>图 1.2<br><br>reserved: 保留字段, 占用*字节, 目前填充为0<br>entry_num: 帧索引表项的个数, 占用*字节, 网络序,无符号整型, 帧索引表项的长度固定为*字节<br><br>1.2 帧索引表 (frame indexing table)<br><br>|&nbsp; &nbsp; &nbsp;8 bytes&nbsp; &nbsp; &nbsp; |&nbsp; &nbsp; &nbsp; &nbsp; 8 bytes&nbsp; &nbsp; &nbsp; &nbsp;|<br>-----------------------------------------------------------<br>| pts_time_ms |&nbsp; &nbsp; &nbsp; file_offset&nbsp; &nbsp; &nbsp; |<br>-----------------------------------------------------------<br>| pts_time_ms |&nbsp; &nbsp; &nbsp;file_offset&nbsp; &nbsp; &nbsp; &nbsp;|<br>-----------------------------------------------------------<br>| ... ... | ... ... |<br>| ... ... | ... ... |<br>-----------------------------------------------------------<br>| pts_time_ms | file_offset&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br>-----------------------------------------------------------<br>图 1.3<br>说明:<br>帧索引表由若干个长度相同的表项 (entry) 紧密排列组成, 每一个表项的长度固定为16字节每个表项的构成如<br>图1.3所示: 由 pts_time_ms 和 file_offset 组成<br><br>帧索引表用于在文件中索引每个帧, 更准确地, 每一个表项均指向了文件中的一个帧数据段: 表项<br>中的pts_time_ms是该帧数据段所包含的帧的起始pts_time, 表项中的file_offset就是该帧数据段<br>在文件中的偏移量<br><br>pts_time_ms: 8字节, 网络序, 无符号整型, 本表项指向的帧数据段的起始pts_time, 单位是ms<br>file_offset: 8字节, 网络序, 无符号整型, 本表项指向的帧数据段在mask文件的偏移<br><br>特别地, 帧索引表中的表项按照其pts_time_ms大小顺序存放, 这使得我们能快速检索某个已知其pts_time_ms的<br>帧所在的帧数据段, 并且, 如果表项A在B前面, 那么A所指向的帧数据段的长度为B.file_offset - A.file_offset<br>, 对于最后一个表项, 则是其file_offset到文件尾的长度<br><br>1.3 帧数据段 (mask frames data segment)<br><br>----------------------------------------------------------------------<br>| mask frames sorted by pts_time_ms, optionally compressed |<br>----------------------------------------------------------------------<br>| ... ... |<br>| ... ... |<br>----------------------------------------------------------------------<br>| mask frames sorted by pts_time_ms, optionally compressed |<br>----------------------------------------------------------------------<br>图 1.4<br>说明:<br>每一个帧数据段都包含了若干连续的帧, 这些帧按照其pts_time_ms从大到小紧密排列, 是否压缩取决<br>于codec_id值<br><br>2. 编码 (mask codec id)<br><br>2.1 codec_id = 0x0 (bitstream, gzip compressed)<br><br>帧格式:<br><br>| 2 bytes&nbsp; |&nbsp; 2 bytes&nbsp; |&nbsp; &nbsp; 8 bytes&nbsp; &nbsp; &nbsp; |&nbsp; (width * height)/8 bytes |<br>----------------------------------------------------------------<br>|&nbsp; &nbsp;width&nbsp; &nbsp;|&nbsp; height&nbsp; &nbsp;| pts_time_ms |&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;<br>----------------------------------------------------------------<br>图 2.1 bitstream 编码方式<br><br>说明:<br>帧的组成如图2.1所示, 由: 帧宽度 + 帧高度 + 帧PTS + 帧数据 组成<br>width: 帧的宽度, 占用2字节, 网络序, 无符号整型<br>height: 帧的高度, 占用2字节, 网络序, 无符号整型<br>pts_time_ms: 帧的pts时间, 占用8字节, 网络序, 无符号整型, 单位 ms<br>data: 帧的二进制数据, 占用 (width * height)/8 字节, 每个bit位代表一个像素点, 宽度优先存储<br><br>帧数据段格式:<br>一系列帧按照其pts_time_ms从小到大紧密排列, 之后使用gzip压缩算法压缩而成, gzip level 9<br><br>2.2 codec_id = 0x1 (svg)<br><br>帧格式:<br><br>| 4 bytes&nbsp; &nbsp; |&nbsp; &nbsp; &nbsp; &nbsp;8 bytes&nbsp; &nbsp; &nbsp; &nbsp;| data_size bytes |<br>-------------------------------------------------------------<br>| data_size |&nbsp; pts_time_ms&nbsp; &nbsp;|&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|<br>-------------------------------------------------------------<br>图 2.2 svg 编码方式<br><br>说明:<br>帧的组成如图2.2所示, 由: 帧数据长度 + 帧PTS + 帧数据 组成<br>data_size: 帧数据的长度, 占用4字节, 网络序, 无符号整型, 帧数据长度不包含data_size字段和pts_time_ms字段本身<br>pts_time_ms: 帧的pts时间, 占用8字节, 网络序, 无符号整型, 单位 ms<br>data: 帧的二进制数据, 占用 data_size 字节, svg格式<br><br>帧数据段格式:<br>一系列帧按照其pts_time_ms从小到大紧密排列, 不压缩<br><br>2.3 codec_id = 0x2 (svg, gzip compressed)<br><br>帧格式:<br><br>|&nbsp; &nbsp; 4 bytes&nbsp; |&nbsp; &nbsp; &nbsp;8 bytes&nbsp; &nbsp; &nbsp;| data_size bytes |<br>-------------------------------------------------------------<br>| data_size | pts_time_ms |&nbsp; &nbsp; &nbsp; &nbsp; data&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |<br>-------------------------------------------------------------<br>图 2.2 svg 编码方式<br><br>说明:<br>帧的组成如图2.2所示, 由: 帧数据长度 + 帧PTS + 帧数据 组成<br>data_size: 帧数据的长度, 占用4字节, 网络序, 帧数据长度不包含data_size字段和pts_time_ms字段本身<br>pts_time_ms: 帧的pts时间, 占用8字节, 网络序, 单位 ms<br>data: 帧的二进制数据, 占用 data_size 字节, svg格式<br><br>帧数据段格式:<br>一系列帧按照其pts_time_ms从小到大紧密排列, 之后使用gzip压缩算法压缩而成, gzip level 9<br></p><p><br></p><p><br></p><p><br></p><p><br></p>"
}